-- Tabla de autoridades
CREATE TABLE SEG_AUTHORITY (
  AUTHORITY_ID NUMBER PRIMARY KEY,
  NAME VARCHAR2(100)
);

-- Tabla de usuarios
CREATE TABLE SEG_USER (
  USER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_NAME VARCHAR2(100) NOT NULL,
  PASSWORD VARCHAR2(255) NOT NULL,
  NAME VARCHAR2(100)
);

-- Tabla intermedia para la relación Many-to-Many
CREATE TABLE SEG_USER_AUTHORITY (
  USER_ID NUMBER NOT NULL,
  AUTHORITY_ID NUMBER NOT NULL,
  PRIMARY KEY (USER_ID, AUTHORITY_ID),
  CONSTRAINT FK_USER_AUTH FOREIGN KEY (USER_ID) REFERENCES SEG_USER(USER_ID),
  CONSTRAINT FK_AUTH_USER FOREIGN KEY (AUTHORITY_ID) REFERENCES SEG_AUTHORITY(AUTHORITY_ID)
);

-- NUEVOS ROLES A TABLA
-- Limpieza de Tablas
DELETE FROM SEG_USER_AUTHORITY WHERE 1=1;
DELETE FROM SEG_USER WHERE 1=1;
DELETE FROM SEG_AUTHORITY WHERE 1=1;

-- Inserción Authorities
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (1, 'ADMIN');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (2, 'VENTAS');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (3, 'CLIENTES_CREAR');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (4, 'CLIENTES_ACTUALIZAR');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (5, 'CLIENTES_ELIMINAR');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (6, 'CLIENTES_LISTA');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (7, 'PEDIDOS_VER');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (8, 'PEDIDOS_GENERAR');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (9, 'PEDIDOS_LISTA');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (10, 'PEDIDOS_CONFIRMAR_PAGO');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (11, 'ALMACEN');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (12, 'PRODUCTOS_LISTA');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (13, 'PRODUCTOS_CREAR');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (14, 'PRODUCTOS_ACTUALIZAR');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (15, 'PRODUCTOS_ELIMINAR');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (16, 'PRODUCTOS_VER');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (17, 'PEDIDOS_CANCELAR_PEDIDO');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (18, 'PEDIDOS_CONFIRMAR_STOCK');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (19, 'PEDIDOS_PREPARAR_PEDIDO');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (20, 'PEDIDOS_PEDIDO_LISTO');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (21, 'PEDIDOS_ENTREGAR');
INSERT INTO SEG_AUTHORITY (AUTHORITY_ID, NAME) VALUES (22, 'PEDIDOS_CREAR');


-- Inserción Usuarios BCrypt
-- La contraseña "$2a$10$e6Ijw.dlWTn8KkEsbF3w9uDgNGFSz/gXV3BVrR/LBElZOmOAtRL4S" es "123456"
INSERT INTO SEG_USER (USER_ID, USER_NAME, PASSWORD, NAME) VALUES (1, 'ADMIN', '$2a$10$e6Ijw.dlWTn8KkEsbF3w9uDgNGFSz/gXV3BVrR/LBElZOmOAtRL4S', 'Administrador');
INSERT INTO SEG_USER (USER_ID, USER_NAME, PASSWORD, NAME) VALUES (2, 'USERVENTAS', '$2a$10$e6Ijw.dlWTn8KkEsbF3w9uDgNGFSz/gXV3BVrR/LBElZOmOAtRL4S', 'Usuario Ventas');
INSERT INTO SEG_USER (USER_ID, USER_NAME, PASSWORD, NAME) VALUES (3, 'USERALMACEN', '$2a$10$e6Ijw.dlWTn8KkEsbF3w9uDgNGFSz/gXV3BVrR/LBElZOmOAtRL4S', 'Usuario Almacen');

-- Asignación Roles al Usuario ADMIN (Todos los Roles)
INSERT INTO SEG_USER_AUTHORITY (USER_ID, AUTHORITY_ID)
SELECT 1, AUTHORITY_ID FROM SEG_AUTHORITY;

-- Asignación Roles al Usuario USERVENTAS
INSERT INTO SEG_USER_AUTHORITY (USER_ID, AUTHORITY_ID)
SELECT 2, AUTHORITY_ID FROM SEG_AUTHORITY
WHERE NAME IN ('VENTAS', 'CLIENTES_CREAR', 'CLIENTES_ACTUALIZAR', 'CLIENTES_ELIMINAR', 'CLIENTES_LISTA', 'PEDIDOS_VER', 'PEDIDOS_GENERAR', 'PEDIDOS_LISTA', 'PEDIDOS_CONFIRMAR_PAGO', 'PEDIDOS_CREAR');

-- Asignación Roles al Usuario USERALMACEN
INSERT INTO SEG_USER_AUTHORITY (USER_ID, AUTHORITY_ID)
SELECT 3, AUTHORITY_ID FROM SEG_AUTHORITY
WHERE NAME IN ('ALMACEN', 'PRODUCTOS_LISTA', 'PRODUCTOS_CREAR', 'PRODUCTOS_ACTUALIZAR', 'PRODUCTOS_ELIMINAR', 'PRODUCTOS_VER', 'PEDIDOS_LISTA', 'PEDIDOS_VER', 'PEDIDOS_CANCELAR_PEDIDO', 'PEDIDOS_CONFIRMAR_STOCK', 'PEDIDOS_PREPARAR_PEDIDO', 'PEDIDOS_PEDIDO_LISTO', 'PEDIDOS_ENTREGAR');

-- Crear vista para ver los roles o authorities por usuario
CREATE VIEW USER_AUTHORITIES AS
SELECT u.USER_ID, u.USER_NAME, u.NAME AS NOMBRE,
       a.AUTHORITY_ID, a.NAME AS AUTHORITY_NAME
FROM SEG_USER u
JOIN SEG_USER_AUTHORITY ua ON u.USER_ID = ua.USER_ID
JOIN SEG_AUTHORITY a ON ua.AUTHORITY_ID = a.AUTHORITY_ID
ORDER BY u.USER_ID, a.AUTHORITY_ID;

SELECT * FROM USER_AUTHORITIES;